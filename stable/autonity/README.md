## Autonity helm chart

[![Join the chat at https://gitter.im/clearmatics/autonity](https://badges.gitter.im/clearmatics/autonity.svg)](https://gitter.im/clearmatics/autonity?utm_source=badge&utm_medium=badge&utm_campaign=pr-badge&utm_content=badge)


## Introduction

This chart deploys a infrastructure for `validator node` that is a member of  **private** [Autonity](https://www.autonity.io/) network onto a [Kubernetes](http://kubernetes.io) 
cluster using the [Helm](https://helm.sh) package manager.   
Autonity is a generalization of the Ethereum protocol based on a fork of go-ethereum.   
[Autonity Documentation](https://docs.autonity.io)

## Initial ceremony
### Phase 1
Actor: Operator
1. Operator sent for each organisation list with entrypoints

    | Organisation name | dns name |
    |-------------------|----------|
    | org1  | validator1.ogr1.com   |
    | org1  | validator2.ogr1.com   |
    | org2  | val2.ogr2.net   |
    | org3  | validator3.ogr3.io    |
    | org4  | othername4.ogr4.co.uk |
    
    Requirements:
    1. Organisation should be owner of their domain
    1. Public fixed IP. Address should be static and unique for `fqdn`
    1. DNSSEC for domain should be enabled
1. Operator also sent `genesis` options for the first block like:
    1. Network_ID
    1. Chain_ID
    1. Max gas price
    1. etc

### Phase 2
Actor: Each validator node
1. Generate  private and public keys for validator node
1. Allocate public fixed static IP and port for p2p connections (only one IP for one `validator-node`)
1. Push this data to own DNS records that was defined at `Phase 1`

    | type | name | value | TTL |
    |------|-------------------|-------------|---|
    | A    | validator1.example.com      | 203.0.113.1 | 1 min |
    | TXT  | validator1.example.com  |p=30303; k=ad840ab412c026b098291f5ab56f923214469c61d4a8be41334c9a00e2dc84a8ff9a5035b3683184ea79902436454a7a00e966de45ff46dbd118e426edd4b2d0| 1 min |

### Phase 3
Actor: Each validator node
1. Check each dns records from list at `Phase 1` every `X` min
1. When all records was resolved, generate `genesis.json` and execute `autonity init`
1. Execute service `autonity`

### Phase 4
Actor: Each validator node
1. Check RPC until new blocks mined
1. Get from `autonity RPC` list of validator nodes in a smart contract and check their own `enodeid`
    1. if it does not match - make alarm?
    1. if it matched - confirm that network was setup correctly
1. Get options from the first mined and confirmed block and check that all of this matched with local genesis.json and no any addition 

## Data storage

1. secret `autonity-node-0` contain:
   1. `private_key` - private key for account
1. configmap `autonity-node-0`, contain:
   1. `address` - address
   1. `pub_key` - public key
1. Kubernetes [EmptyDir](https://kubernetes.io/docs/concepts/storage/volumes/#emptydir) (default) for local blockchain 
of `autonity-nodes`    
   1. `aws_persistent_storage_enabled: true` enable AWS persistent storage for `blockchain`
   1. `gcp_persistent_storage_enabled: true` enable GCP persistent storage for `blockchain`
1. configmap `genesis-template` contain list of peers, genesis options received from Operator:
   1. `genesis.json`  format [Autonity genesis.json](https://github.com/clearmatics/autonity/wiki/Genesis-File-Configuration) 
   with `fqdn://` scheme support [issue #310](https://github.com/clearmatics/autonity/issues/310) 
1. configmap `genesis` generated by job `init-job02-genesis-configurator` when all `fqdn://` DNS records resolved to `enode://`

## Metrics by InfluxDB

You can send `autonity` metrics to InfluxDB cloud. (Disabled by default).
* Create InfluxDB2 cloud account here: [cloud2.influxdata.com](https://cloud2.influxdata.com/) It is for free for limited testing usage.
* Get your organisation name from Org Profile
* Create bucket
* Create token

Put it to [values.yaml](./values.yaml) as a `telegraf:` values

## Workshops
* [Initial ceremony](./docs/workshop_initial_ceremony.md) Setup new network with validator nodes on different clouds (`EKS` and `GKE`)
* [Join new node](./docs/workshop_join_new_node.md) Join new node to existing network
